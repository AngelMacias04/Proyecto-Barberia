<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel</title>
  <style>
    :root{
      --bg1:#0ea5e9; --bg2:#8b5cf6; --card:#0b1020f2; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#38bdf8; --ring:0 0 0 3px rgba(56,189,248,.35); --radius:18px; --shadow:0 10px 35px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);
      background:radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.05) 0 35%, transparent 35% 100%),
                 linear-gradient(120deg,var(--bg1),var(--bg2));
      display:grid;place-items:start center
    }
    .wrap{width:min(1100px,92vw);margin:42px 0}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.2);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    h1{margin:0 0 10px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin:12px 0 16px}
    .btn{
      border:1px solid rgba(148,163,184,.25);background:#0f172a;color:var(--text);
      padding:12px;border-radius:14px;text-align:center;cursor:pointer;user-select:none;
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .btn:hover{transform:translateY(-2px)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 10px}
    .btn-sm{padding:8px 12px;border-radius:12px}
    .btn-primary{border-color:var(--accent);box-shadow:var(--ring)}
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{border:1px solid rgba(148,163,184,.25);padding:8px 10px;font-size:.95rem}
    th{background:#101a34}
    .hint{color:var(--muted);margin-top:6px}
    a.link{color:var(--accent);text-decoration:none}
    a.link:hover{text-decoration:underline}
    #data-table td[contenteditable="true"]{background:rgba(56,189,248,.08)}
    #data-table tr.selected{outline:2px solid var(--accent)}
    #create-row td{background:rgba(34,197,94,.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1 id="panel-title">Panel</h1>
          <div class="muted">Bienvenido, {{ request.session.username }}</div>
        </div>
      </div>

      <div class="muted">Tablas disponibles</div>
      <div class="grid">
        <button class="btn" data-table="duenio">Duenio</button>
        <button class="btn" data-table="barbero">Barbero</button>
        <button class="btn" data-table="cliente">Cliente</button>
        <button class="btn" data-table="pagos">Pagos</button>
        <button class="btn" data-table="servicios">Servicios</button>
        <button class="btn" data-table="citas">Citas</button>
        <button class="btn" data-table="resultados">Resultados</button>
      </div>

      <!-- Barra de navegacion CRUD -->
      <div class="toolbar">
        <button id="btn-create"  class="btn btn-sm btn-primary" title="Crear registro con la fila en blanco">Crear</button>
        <button id="btn-edit"    class="btn btn-sm" title="Habilitar edición en celdas">Modificar</button>
        <button id="btn-save"    class="btn btn-sm" title="Guardar todos los cambios" disabled>Guardar cambios</button>
        <button id="btn-cancel"  class="btn btn-sm" title="Cancelar edición" disabled>Cancelar</button>
        <button id="btn-delete"  class="btn btn-sm" title="Eliminar una fila seleccionada">Eliminar</button>
      </div>

      <div id="status" class="hint">Selecciona una tabla.</div>
      <div id="table-wrap"></div>
    </div>
  </div>

  <script>
    // === Rol desde la sesión ===
    const ROLE = "{{ request.session.role|default:''|lower }}";

    const gridBtns   = document.querySelectorAll('.grid .btn');
    const statusEl   = document.getElementById('status');
    const wrap       = document.getElementById('table-wrap');
    const titleEl    = document.getElementById('panel-title');

    const btnCreate  = document.getElementById('btn-create');
    const btnEdit    = document.getElementById('btn-edit');
    const btnSave    = document.getElementById('btn-save');
    const btnCancel  = document.getElementById('btn-cancel');
    const btnDelete  = document.getElementById('btn-delete');

    // Título dinámico
    const titleByRole = { duenio: 'Panel del Dueño', barbero: 'Panel del Barbero', cliente: 'Panel del Cliente' };
    titleEl.textContent = titleByRole[ROLE] || 'Panel';

    // ===== Permisos por acción según rol/tabla =====
    function getPerms(table) {
      const none = { create:false, update:false, del:false };
      if (!table) return none;

      if (ROLE === 'duenio') return { create:true, update:true, del:true };

      if (ROLE === 'barbero') {
        const citas = (table === 'citas');
        // resultados readonly; pagos/servicios no aparecen para barbero normalmente
        return { create:citas, update:citas, del:citas };
      }

      if (ROLE === 'cliente') {
        const citas = (table === 'citas');
        // pagos/servicios readonly
        return { create:citas, update:citas, del:citas };
      }

      return none;
    }

    // Mostrar/ocultar cada botón según permisos
    function applyToolbar(perms) {
      btnCreate.style.display = perms.create ? '' : 'none';
      [btnEdit, btnSave, btnCancel].forEach(b => b.style.display = perms.update ? '' : 'none');
      btnDelete.style.display = perms.del ? '' : 'none';

      if (!perms.update) { editable = false; btnSave.disabled = true; btnCancel.disabled = true; }
      deleteMode = false; selectedPk = null;
    }

    let currentTable = null;
    let cols = [];
    let editable = false;
    let deleteMode = false;
    let selectedPk = null;

    // Al inicio: oculta toolbar (ninguna tabla seleccionada)
    applyToolbar(getPerms(null));

    function getPkField() {
      if (!cols.length) return null;
      return cols.find(k => k.startsWith('id_')) || cols.find(k => k.endsWith('_id')) || cols[0];
    }

    async function solicitarTabla(nombreTabla) {
      currentTable = nombreTabla;
      editable = false; deleteMode = false; selectedPk = null;
      btnSave.disabled = true; btnCancel.disabled = true;

      // Aplica permisos de la tabla seleccionada
      applyToolbar(getPerms(nombreTabla));

      statusEl.textContent = 'Cargando ' + nombreTabla + '...';
      wrap.innerHTML = '';
      try {
        const res = await fetch("{% url 'api_solicitar_tabla' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: nombreTabla })
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error'; return; }

        const rows = data.rows || [];
        statusEl.textContent = rows.length + ' registro(s) encontrados.';
        renderTable(rows);
      } catch (e) {
        statusEl.textContent = 'Error de red.';
      }
    }

    function renderTable(rows) {
      wrap.innerHTML = '';
      if (!rows.length) { wrap.innerHTML = '<div class="hint">No hay datos.</div>'; cols = []; return; }

      cols = Object.keys(rows[0]);
      let html = '<table id="data-table"><thead><tr>';
      cols.forEach(c => html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';

      // filas existentes
      rows.forEach(r => {
        html += '<tr>';
        cols.forEach(c => html += `<td>${r[c] ?? ''}</td>`);
        html += '</tr>';
      });

      // Fila en blanco para CREATE (solo si hay permiso de crear)
      if (getPerms(currentTable).create) {
        html += '<tr id="create-row">';
        cols.forEach(() => html += `<td contenteditable="true"></td>`);
        html += '</tr>';
      }

      html += '</tbody></table>';
      wrap.innerHTML = html;

      // selección para eliminar
      document.querySelectorAll('#data-table tbody tr').forEach(tr => {
        tr.addEventListener('click', () => {
          if (!deleteMode || tr.id === 'create-row') return;
          document.querySelectorAll('#data-table tbody tr').forEach(t => t.classList.remove('selected'));
          tr.classList.add('selected');

          const tds = Array.from(tr.querySelectorAll('td'));
          const pkField = getPkField();
          const pkIndex = cols.indexOf(pkField);
          selectedPk = pkIndex >= 0 ? (tds[pkIndex]?.innerText.trim() || null) : null;
        });
      });
    }

    // ---------- CREATE ----------
    btnCreate.addEventListener('click', async () => {
      if (!currentTable || !cols.length) return;
      if (!getPerms(currentTable).create) return;

      const tr = document.getElementById('create-row');
      if (!tr) { statusEl.textContent = 'No hay fila de creación.'; return; }

      const tds = Array.from(tr.querySelectorAll('td'));
      const row = {};
      cols.forEach((c,i) => row[c] = (tds[i].innerText || '').trim());

      const allFilled = Object.values(row).every(v => v !== '');
      if (!allFilled) { statusEl.textContent = 'Completa todos los campos para crear.'; return; }

      try {
        const res = await fetch("{% url 'api_crear_registro' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: currentTable, row })
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error al crear.'; return; }

        statusEl.textContent = 'Registro creado.';
        solicitarTabla(currentTable);
      } catch {
        statusEl.textContent = 'Error de red al crear.';
      }
    });

    // ---------- EDIT ----------
    btnEdit.addEventListener('click', () => {
      if (!currentTable || !cols.length) return;
      if (!getPerms(currentTable).update) return;

      editable = true; deleteMode = false; selectedPk = null;
      btnSave.disabled = false; btnCancel.disabled = false;

      document.querySelectorAll('#data-table tbody tr:not(#create-row) td')
        .forEach(td => td.setAttribute('contenteditable','true'));

      statusEl.textContent = 'Edición habilitada. Modifica celdas y pulsa "Guardar cambios".';
    });

    btnCancel.addEventListener('click', () => {
      if (!currentTable) return;
      solicitarTabla(currentTable);
    });

    btnSave.addEventListener('click', async () => {
      if (!currentTable || !cols.length) return;
      if (!getPerms(currentTable).update) return;

      const rows = [];
      document.querySelectorAll('#data-table tbody tr').forEach(tr => {
        if (tr.id === 'create-row') return;
        const tds = Array.from(tr.querySelectorAll('td'));
        const obj = {};
        cols.forEach((c,i) => obj[c] = (tds[i].innerText || '').trim());
        rows.push(obj);
      });

      try {
        const res = await fetch("{% url 'api_actualizar_tabla' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: currentTable, rows })
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error al actualizar.'; return; }

        statusEl.textContent = `Actualizados: ${data.updated}`;
        solicitarTabla(currentTable);
      } catch {
        statusEl.textContent = 'Error de red al guardar.';
      }
    });

    // ---------- DELETE ----------
    btnDelete.addEventListener('click', async () => {
      if (!currentTable || !cols.length) return;
      if (!getPerms(currentTable).del) return;

      if (!deleteMode) {
        deleteMode = true; editable = false; selectedPk = null;
        btnSave.disabled = true; btnCancel.disabled = false;
        document.querySelectorAll('#data-table td').forEach(td => td.removeAttribute('contenteditable'));
        statusEl.textContent = 'Modo eliminar: haz clic en una fila (no la de creación) para seleccionarla.';
        return;
      }

      if (!selectedPk) { statusEl.textContent = 'Selecciona una fila para eliminar.'; return; }
      const ok = confirm('¿Eliminar el registro seleccionado?');
      if (!ok) { statusEl.textContent = 'Eliminación cancelada.'; deleteMode=false; return; }

      try {
        const res = await fetch("{% url 'api_eliminar_registro' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: currentTable, pk: selectedPk })
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error al eliminar.'; return; }

        statusEl.textContent = 'Registro eliminado.';
        solicitarTabla(currentTable);
      } catch {
        statusEl.textContent = 'Error de red al eliminar.';
      } finally {
        deleteMode = false;
      }
    });

    // listeners de los botones de tabla
    gridBtns.forEach(b => b.addEventListener('click', () => solicitarTabla(b.dataset.table)));
    // opcional: precargar una tabla
    // solicitarTabla('citas');
  </script>
</body>
</html>
