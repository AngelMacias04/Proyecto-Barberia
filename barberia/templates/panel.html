<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIENVENIDO</title>
  {% load static %}
  <link rel="icon" type="image/png" href="{% static 'favicon.png' %}?v=4">
  <style>
    :root{
      --bg1:#0ea5e9; --bg2:#8b5cf6; --card:#0b1020f2; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#38bdf8; --ring:0 0 0 3px rgba(56,189,248,.35); --radius:18px; --shadow:0 10px 35px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);
      background:radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.05) 0 35%, transparent 35% 100%),
                 linear-gradient(120deg,var(--bg1),var(--bg2));
      display:grid;place-items:start center
    }
    .wrap{width:min(1300px,96vw);margin:42px 0}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.2);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    h1{margin:0 0 10px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin:12px 0 16px}
    .btn{
      border:1px solid rgba(148,163,184,.25);background:#0f172a;color:var(--text);
      padding:12px;border-radius:14px;text-align:center;cursor:pointer;user-select:none;
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .btn:hover{transform:translateY(-2px)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 10px}
    .btn-sm{padding:8px 12px;border-radius:12px}
    .btn-primary{border-color:var(--accent);box-shadow:var(--ring)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;margin-top:6px;table-layout:auto}
    th,td{border:1px solid rgba(148,163,184,.25);padding:8px 10px;font-size:.95rem;white-space:nowrap}
    th{background:#101a34}
    .ok{background:#064e3b;color:#d1fae5}
    .bad{background:#7f1d1d;color:#fee2e2}
    .hint{color:var(--muted);margin-top:6px}
    a.link{color:var(--accent);text-decoration:none}
    a.link:hover{text-decoration:underline}

    /* Edición / selección */
    #data-table td[contenteditable="true"]{background:rgba(56,189,248,.08)}
    #data-table tr.selected{outline:2px solid var(--accent)}
    #create-row td{background:rgba(34,197,94,.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <!-- <h1>Panel del Dueño</h1> -->
          <div class="muted">Bienvenido, {{ request.session.username }}</div>
        </div>
      </div>

      <div class="muted">Tablas disponibles</div>
        <h1>
            {% if request.session.role == 'barbero' %}Panel del Barbero
            {% elif request.session.role == 'cliente' %}Panel del Cliente
            {% else %}Panel del Dueño
            {% endif %}
        </h1>

        <div class="grid">
            {% if request.session.role == 'duenio' %}
                <button class="btn" data-table="duenio">Duenio</button>
                <button class="btn" data-table="barbero">Barbero</button>
                <button class="btn" data-table="cliente">Cliente</button>
                <button class="btn" data-table="pagos">Pagos</button>
                <button class="btn" data-table="servicios">Servicios</button>
                <button class="btn" data-table="citas">Citas</button>
                <button class="btn" data-table="resultados">Resultados</button>
                <button class="btn" id="btn-ranking" data-ranking="true">Ranking</button>
            {% elif request.session.role == 'barbero' %}
                <button class="btn" data-table="citas">Citas</button>
                <button class="btn" data-table="resultados">Resultados</button>
            {% elif request.session.role == 'cliente' %}
                <button class="btn" data-table="pagos">Pagos</button>
                <button class="btn" data-table="servicios">Servicios</button>
                <button class="btn" data-table="citas">Citas</button>
            {% endif %}
        </div>
      
      <!-- Barra de acciones CRUD -->
      <div class="toolbar">
        <button id="btn-create"  class="btn btn-sm btn-primary" title="Crear registro con la fila en blanco">Crear</button>
        <button id="btn-edit"    class="btn btn-sm" title="Habilitar edición en celdas">Modificar</button>
        <button id="btn-save"    class="btn btn-sm" title="Guardar todos los cambios" disabled>Guardar cambios</button>
        <button id="btn-cancel"  class="btn btn-sm" title="Cancelar edición" disabled>Cancelar</button>
        <button id="btn-delete"  class="btn btn-sm" title="Eliminar una fila seleccionada">Eliminar</button>
        {% if request.session.role == 'duenio' %}
        <button id="btn-export"  class="btn btn-sm" title="Respaldar tabla actual a CSV">Respaldar CSV</button>
        <button id="btn-import"  class="btn btn-sm" title="Importar CSV a la tabla actual">Importar CSV</button>
        <input type="file" id="input-import" accept=".csv" style="display:none">
        <button id="btn-export-all" class="btn btn-sm" title="Respaldar todas las tablas a ZIP de CSVs">Respaldar todo</button>
        <button id="btn-import-all" class="btn btn-sm" title="Restaurar todas las tablas desde ZIP de CSVs">Importar todo</button>
        <input type="file" id="input-import-all" accept=".zip" style="display:none">
        {% endif %}
      </div>

      <div id="status" class="hint">Selecciona una tabla.</div>
      <div id="table-wrap" class="table-wrap"></div>

      {% if request.session.role == 'duenio' %}
      <div class="card" id="rank-card" style="margin-top:18px;background:#0f1a33;border-color:rgba(148,163,184,.25);display:none">
        <div class="top" style="margin-bottom:8px">
          <h3 style="margin:0">Ranking de servicios y clientes</h3>
          <div class="muted">Consulta por rango de fechas</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
          <label class="muted">Inicio<br><input id="rank-inicio" type="date" style="padding:8px;border-radius:10px;border:1px solid rgba(148,163,184,.3);background:#0b1020;color:var(--text)"></label>
          <label class="muted">Fin<br><input id="rank-fin" type="date" style="padding:8px;border-radius:10px;border:1px solid rgba(148,163,184,.3);background:#0b1020;color:var(--text)"></label>
          <label class="muted">Límite<br>
            <select id="rank-limit" style="padding:8px;border-radius:10px;border:1px solid rgba(148,163,184,.3);background:#0b1020;color:var(--text)">
              <option value="5">Top 5</option>
              <option value="10">Top 10</option>
            </select>
          </label>
          <button id="btn-rank" class="btn btn-sm btn-primary">Ver ranking</button>
        </div>
        <div id="rank-status" class="hint" style="margin-top:8px">Sin resultados.</div>
        <div id="rank-wrap" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px"></div>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    // Qué campos son obligatorios por tabla (ajústalo a tus reglas)
    const REQUIRED_FIELDS = {
      citas: ['id_cita','id_barbero_id','id_cliente_id','dia','hora','servicio1_id','total'],
      servicios: ['id_servicio','servicio','precio'],
      pagos: ['id_tipodepago','tipodepago'],
      resultados: ['id_resultado','id_barbero_id','id_cita_id','total'],
      barbero: ['id_barbero'],
      cliente: ['id_cliente'],
      duenio: ['id_duenio','user','password']
    };

    // '' o 'NULL' → null (NULL real de JSON/SQL)
    function normalizeValue(v){
      const t = (v ?? '').trim();
      if (t === '' || /^null$/i.test(t)) return null;
      return t;
    }


    // === NUEVO: rol en JS ===
    const ROLE = "{{ request.session.role|default:''|lower }}";
    const SERVICE_FIELDS = ['servicio1_id','servicio2_id','servicio3_id'];
    let SERVICES_CACHE = [];
    let BARBEROS_CACHE = [];

    const gridBtns   = document.querySelectorAll('.grid .btn');
    const statusEl   = document.getElementById('status');
    const wrap       = document.getElementById('table-wrap');

    const toolbarEl  = document.querySelector('.toolbar'); // === NUEVO ===
    const btnCreate  = document.getElementById('btn-create');
    const btnEdit    = document.getElementById('btn-edit');
    const btnSave    = document.getElementById('btn-save');
    const btnCancel  = document.getElementById('btn-cancel');
    const btnDelete  = document.getElementById('btn-delete');
    const btnExport  = document.getElementById('btn-export');
    const btnImport  = document.getElementById('btn-import');
    const inputImport= document.getElementById('input-import');
    const btnExportAll = document.getElementById('btn-export-all');
    const btnImportAll = document.getElementById('btn-import-all');
    const inputImportAll = document.getElementById('input-import-all');
    const btnRank    = document.getElementById('btn-rank');
    const btnRankingToggle = document.getElementById('btn-ranking');
    const rankWrap   = document.getElementById('rank-wrap');
    const rankStatus = document.getElementById('rank-status');
    const rankCard   = document.getElementById('rank-card');

    let currentTable = null;
    let cols = [];            // columnas actuales
    let editable = false;     // modo edición
    let deleteMode = false;   // modo eliminar
    let selectedPk = null;    // PK seleccionada para eliminar
    let servicesReady = false;
    let barberosReady = false;
    let editServiceControls = []; // para selects en modo edición
    let currentRowsData = []; // datos actuales de la tabla

    // === NUEVO: qué tablas son solo lectura según rol ===
    function isReadonly(table) {
      if (!table) return true;
      if (ROLE === 'duenio') return false; // dueño ve todo con CRUD
      if (ROLE === 'barbero') return table === 'resultados';
      if (ROLE === 'cliente') return (table === 'pagos' || table === 'servicios');
      return true;
    }

    // === NUEVO: mostrar/ocultar la toolbar completa ===
    function setToolbarFor(table) {
      const hide = isReadonly(table);
      toolbarEl.style.display = hide ? 'none' : '';
      // reset estados si oculto
      if (hide) {
        editable   = false;
        deleteMode = false;
        selectedPk = null;
        btnSave.disabled   = true;
        btnCancel.disabled = true;
      }
    }

    // Al inicio, sin tabla seleccionada => oculta toolbar
    setToolbarFor(null); // === NUEVO ===

    // Heurística simple para detectar la PK desde las columnas (MVP)
    function getPkField() {
      if (!cols.length) return null;
      let c = cols.find(k => k.startsWith('id_')) || cols.find(k => k.endsWith('_id')) || cols[0];
      return c;
    }

    function hasCitaConflict(barbero, dia, hora, selfPk, rowsPool) {
      if (!barbero || !dia || !hora) return false;
      return rowsPool.some(r =>
        r.id_barbero_id == barbero &&
        r.dia == dia &&
        r.hora == hora &&
        (!selfPk || r.id_cita != selfPk)
      );
    }

    function mergeEditsIntoCurrent(edits, pkField) {
      const map = new Map();
      currentRowsData.forEach(r => map.set(r[pkField], {...r}));
      edits.forEach(r => {
        if (r[pkField]) {
          map.set(r[pkField], {...(map.get(r[pkField])||{}), ...r});
        } else {
          map.set(`tmp-${Math.random()}`, {...r});
        }
      });
      return Array.from(map.values());
    }

    function hasDuplicateSchedule(rows, pkField) {
      const seen = new Set();
      for (const r of rows) {
        const b = r.id_barbero_id;
        const d = r.dia;
        const h = r.hora;
        if (!b || !d || !h) continue;
        const key = `${b}|${d}|${h}`;
        if (seen.has(key)) return true;
        seen.add(key);
      }
      return false;
    }

    function snapshotCitasFromDom(includeCreate=false) {
      if (currentTable !== 'citas') return currentRowsData;
      const pkField = getPkField() || 'id_cita';
      const map = new Map();
      currentRowsData.forEach(r => map.set(r[pkField], {...r}));
      const rows = document.querySelectorAll('#data-table tbody tr' + (includeCreate ? '' : ':not(#create-row)'));
      rows.forEach(tr => {
        const obj = {};
        cols.forEach((c, idx) => {
          const td = tr.children[idx];
          if (!td) return;
          const sel = td.querySelector('select');
          const val = sel ? sel.value : (td.innerText || '').trim();
          obj[c] = val;
        });
        const pk = obj[pkField] || `tmp-${Math.random()}`;
        obj[pkField] = pk;
        map.set(pk, {...(map.get(pk) || {}), ...obj});
      });
      return Array.from(map.values());
    }

    async function solicitarTabla(nombreTabla) {
      currentTable = nombreTabla;
      editable = false; deleteMode = false; selectedPk = null;
      btnSave.disabled = true; btnCancel.disabled = true;

      // === NUEVO: aplica visibilidad de toolbar según la tabla elegida
      setToolbarFor(nombreTabla);

      statusEl.textContent = 'Cargando ' + nombreTabla + '...';
      wrap.innerHTML = '';
      try {
        const res = await fetch("{% url 'api_solicitar_tabla' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: nombreTabla })
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error'; return; }

        const rows = data.rows || [];
        currentRowsData = rows;
        statusEl.textContent = rows.length + ' registro(s) encontrados.';
        if (nombreTabla === 'citas' && !servicesReady) {
          await fetchServiciosCatalog();
        }
        if (nombreTabla === 'citas' && !barberosReady) {
          await fetchBarberosCatalog();
        }
        renderTable(rows);
      } catch (e) {
        statusEl.textContent = 'Error de red.';
      }
    }

    function renderTable(rows) {
      wrap.innerHTML = '';
      if (!rows.length) { wrap.innerHTML = '<div class="hint">No hay datos.</div>'; cols = []; return; }

      cols = Object.keys(rows[0]);
      let html = '<table id="data-table"><thead><tr>';
      cols.forEach(c => html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';

      // filas existentes
      rows.forEach(r => {
        html += '<tr>';
        cols.forEach(c => html += `<td>${r[c] ?? ''}</td>`);
        html += '</tr>';
      });

      // === NUEVO: solo agrego fila de CREATE si NO es readonly
      if (!isReadonly(currentTable)) {
        html += '<tr id="create-row">';
        cols.forEach((c) => {
          if (currentTable === 'citas' && SERVICE_FIELDS.includes(c)) {
            html += `<td class="svc-cell"><select data-svc="${c}" style="min-width:180px;"></select></td>`;
          } else if (currentTable === 'citas' && c === 'total') {
            html += `<td id="citas-total-cell"></td>`;
          } else if (currentTable === 'citas' && c === 'id_barbero_id' && ROLE !== 'barbero') {
            html += `<td><select data-barbero="create" style="min-width:150px;"></select></td>`;
          } else if (currentTable === 'citas' && c === 'hora') {
            html += `<td class="hora-cell"><select data-hora="create"></select></td>`;
          } else {
            html += `<td contenteditable="true"></td>`;
          }
        });
        html += '</tr>';
      }

      html += '</tbody></table>';
      wrap.innerHTML = html;

      // selección para eliminar
      document.querySelectorAll('#data-table tbody tr').forEach(tr => {
        tr.addEventListener('click', () => {
          if (!deleteMode || tr.id === 'create-row') return;
          document.querySelectorAll('#data-table tbody tr').forEach(t => t.classList.remove('selected'));
          tr.classList.add('selected');

          // Calcula PK de la fila seleccionada
          const tds = Array.from(tr.querySelectorAll('td'));
          const pkField = getPkField();
          const pkIndex = cols.indexOf(pkField);
          selectedPk = pkIndex >= 0 ? (tds[pkIndex]?.innerText.trim() || null) : null;
        });
      });
    }

    // ---------- CREATE ----------
    btnCreate.addEventListener('click', async () => {
      if (!currentTable || !cols.length || isReadonly(currentTable)) return;

      const tr = document.getElementById('create-row');
      if (!tr) { statusEl.textContent = 'No hay fila de creación.'; return; }

      const tds = Array.from(tr.querySelectorAll('td'));
      const row = {};
      cols.forEach((c,i) => {
        if (currentTable === 'citas' && SERVICE_FIELDS.includes(c)) {
          const sel = tds[i].querySelector('select');
          row[c] = sel ? (sel.value || null) : null;
        } else if (currentTable === 'citas' && c === 'id_barbero_id' && ROLE !== 'barbero') {
          const sel = tds[i].querySelector('select');
          row[c] = sel ? (sel.value || null) : normalizeValue(tds[i].innerText);
        } else if (currentTable === 'citas' && c === 'id_barbero_id' && ROLE !== 'barbero') {
          const sel = tds[i].querySelector('select');
          row[c] = sel ? (sel.value || null) : null;
        } else if (currentTable === 'citas' && c === 'hora') {
          const sel = tds[i].querySelector('select');
          row[c] = sel ? (sel.value || null) : normalizeValue(tds[i].innerText);
        } else if (currentTable === 'citas' && c === 'total') {
          row[c] = Number(document.getElementById('citas-total-cell')?.textContent || 0);
        } else {
          row[c] = normalizeValue(tds[i].innerText);
        }
      });

      const required = REQUIRED_FIELDS[currentTable] || [];
      const missing = required.filter(k => row[k] === null);
      if (missing.length){
        statusEl.textContent = 'Faltan campos obligatorios: ' + missing.join(', ');
        return;
      }

      if (currentTable === 'citas') {
        const pkField = getPkField() || 'id_cita';
        const merged = mergeEditsIntoCurrent([row], pkField);
        if (hasDuplicateSchedule(merged, pkField)) {
          statusEl.textContent = 'barbero_ocupado (validación local)';
          return;
        }
      }

      try {
        const res = await fetch("{% url 'api_crear_registro' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: currentTable, row })
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error al crear.'; return; }
        statusEl.textContent = 'Registro creado.';
        solicitarTabla(currentTable);
      } catch {
        statusEl.textContent = 'Error de red al crear.';
      }
    });

    // ---------- EDIT ----------
    btnEdit.addEventListener('click', async () => {
      if (!currentTable || !cols.length) return;
      if (isReadonly(currentTable)) return; // === NUEVO ===

      editable = true; deleteMode = false; selectedPk = null;
      btnSave.disabled = false; btnCancel.disabled = false;
      editServiceControls = [];

      // cargar servicios si no están
      if (currentTable === 'citas' && !servicesReady) {
        await fetchServiciosCatalog();
      }
      if (currentTable === 'citas' && !barberosReady) {
        await fetchBarberosCatalog();
      }

      const bodyRows = document.querySelectorAll('#data-table tbody tr:not(#create-row)');
      bodyRows.forEach(tr => {
        tr.querySelectorAll('td').forEach((td, idx) => {
          const col = cols[idx];
          const current = (td.innerText || '').trim();
          if (currentTable === 'citas') {
            if (SERVICE_FIELDS.includes(col)) {
              td.dataset.original = current;
              td.innerHTML = `<select data-svc-edit="${col}" style="min-width:180px;"></select>`;
              const sel = td.querySelector('select');
              sel.dataset.original = current;
            } else if (col === 'id_barbero_id' && ROLE !== 'barbero') {
              td.dataset.original = current;
              td.innerHTML = `<select data-barbero-edit="true" style="min-width:150px;"></select>`;
              const sel = td.querySelector('select');
              sel.dataset.original = current;
            } else if (col === 'total') {
              td.innerText = current;
              td.dataset.originalTotal = current;
              td.removeAttribute('contenteditable');
            } else {
              td.setAttribute('contenteditable','true');
            }
          } else {
            td.setAttribute('contenteditable','true');
          }
        });
      });

      if (currentTable === 'citas') {
        setupEditSelectsForCitas();
      }

      statusEl.textContent = 'Edición habilitada. Modifica celdas y pulsa "Guardar cambios".';
    });

    btnCancel.addEventListener('click', () => {
      if (!currentTable) return;
      solicitarTabla(currentTable); // recarga y limpia estados
    });

    btnSave.addEventListener('click', async () => {
      if (!currentTable || !cols.length) return;
      if (isReadonly(currentTable)) return; // === NUEVO ===

      const rows = [];
      document.querySelectorAll('#data-table tbody tr').forEach(tr => {
        if (tr.id === 'create-row') return;
        const tds = Array.from(tr.querySelectorAll('td'));
        const obj = {};
        cols.forEach((c,i) => {
          if (currentTable === 'citas' && SERVICE_FIELDS.includes(c)) {
            const sel = tds[i].querySelector('select');
            obj[c] = sel ? sel.value : (tds[i].innerText || '').trim();
          } else if (currentTable === 'citas' && c === 'id_barbero_id' && ROLE !== 'barbero') {
            const sel = tds[i].querySelector('select');
            obj[c] = sel ? sel.value : (tds[i].innerText || '').trim();
          } else if (currentTable === 'citas' && c === 'hora') {
            const sel = tds[i].querySelector('select');
            obj[c] = sel ? sel.value : (tds[i].innerText || '').trim();
          } else if (currentTable === 'citas' && c === 'total') {
            obj[c] = (tds[i].innerText || '').trim();
          } else {
            obj[c] = (tds[i].innerText || '').trim();
          }
        });
        rows.push(obj);
      });

      if (currentTable === 'citas') {
        const pkField = getPkField() || 'id_cita';
        const merged = mergeEditsIntoCurrent(rows, pkField);
        if (hasDuplicateSchedule(merged, pkField)) {
          statusEl.textContent = 'barbero_ocupado (validación local)';
          return;
        }
      }

      try {
        const res = await fetch("{% url 'api_actualizar_tabla' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: currentTable, rows })
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error al actualizar.'; return; }

        statusEl.textContent = `Actualizados: ${data.updated}`;
        solicitarTabla(currentTable);
      } catch {
        statusEl.textContent = 'Error de red al guardar.';
      }
    });

    // ---------- DELETE ----------
    btnDelete.addEventListener('click', async () => {
      if (!currentTable || !cols.length) return;
      if (isReadonly(currentTable)) return; // === NUEVO ===

      // 1er click: entra en modo selección
      if (!deleteMode) {
        deleteMode = true; editable = false; selectedPk = null;
        btnSave.disabled = true; btnCancel.disabled = false;

        // deshabilitar edición visual si estaba activa
        document.querySelectorAll('#data-table td').forEach(td => td.removeAttribute('contenteditable'));

        statusEl.textContent = 'Modo eliminar: haz clic en una fila (no la de creación) para seleccionarla.';
        return;
      }

      // 2do click (ya hay fila seleccionada): confirmar y eliminar
      if (!selectedPk) { statusEl.textContent = 'Selecciona una fila para eliminar.'; return; }
      const ok = confirm('¿Eliminar el registro seleccionado?');
      if (!ok) { statusEl.textContent = 'Eliminación cancelada.'; deleteMode=false; return; }

      try {
        const res = await fetch("{% url 'api_eliminar_registro' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: currentTable, pk: selectedPk })
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error al eliminar.'; return; }

        statusEl.textContent = 'Registro eliminado.';
        solicitarTabla(currentTable);
      } catch {
        statusEl.textContent = 'Error de red al eliminar.';
      } finally {
        deleteMode = false;
      }
    });

    // ---------- EXPORT / IMPORT CSV (solo dueño) ----------
    async function exportCsv() {
      if (!btnExport) return;
      if (!currentTable || !cols.length) { statusEl.textContent = 'Selecciona una tabla para exportar.'; return; }
      try {
        const res = await fetch("{% url 'api_export_csv' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: currentTable })
        });
        if (!res.ok) { statusEl.textContent = 'Error al exportar.'; return; }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = res.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g,'') || `${currentTable}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        statusEl.textContent = 'CSV descargado.';
      } catch {
        statusEl.textContent = 'Error de red al exportar.';
      }
    }

    async function importCsv(file) {
      if (!currentTable) { statusEl.textContent = 'Selecciona una tabla para importar.'; return; }
      const fd = new FormData();
      fd.append('table', currentTable);
      fd.append('file', file);
      statusEl.textContent = 'Importando...';
      try {
        const res = await fetch("{% url 'api_import_csv' %}", {
          method: 'POST',
          body: fd
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error al importar.'; return; }
        statusEl.textContent = `Importación completada. Filas creadas: ${data.created}`;
        solicitarTabla(currentTable);
      } catch {
        statusEl.textContent = 'Error de red al importar.';
      }
    }

    if (btnExport) {
      btnExport.addEventListener('click', exportCsv);
    }
    if (btnImport && inputImport) {
      btnImport.addEventListener('click', () => inputImport.click());
      inputImport.addEventListener('change', () => {
        if (inputImport.files && inputImport.files[0]) {
          importCsv(inputImport.files[0]);
          inputImport.value = '';
        }
      });
    }

    // Export/Import ALL
    async function exportAll() {
      if (!btnExportAll) return;
      statusEl.textContent = 'Generando respaldo completo...';
      try {
        const res = await fetch("{% url 'api_export_all' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        if (!res.ok) { statusEl.textContent = 'Error al exportar todo.'; return; }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = res.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g,'') || 'backup.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        statusEl.textContent = 'Respaldo completo descargado.';
      } catch {
        statusEl.textContent = 'Error de red al exportar todo.';
      }
    }

    async function importAll(file) {
      if (!btnImportAll) return;
      const fd = new FormData();
      fd.append('file', file);
      statusEl.textContent = 'Restaurando todo...';
      try {
        const res = await fetch("{% url 'api_import_all' %}", {
          method: 'POST',
          body: fd
        });
        const data = await res.json();
        if (!data.ok) { statusEl.textContent = data.error || 'Error al importar todo.'; return; }
        statusEl.textContent = 'Restauración completa.';
        if (currentTable) solicitarTabla(currentTable);
      } catch {
        statusEl.textContent = 'Error de red al importar todo.';
      }
    }

    if (btnExportAll) btnExportAll.addEventListener('click', exportAll);
    if (btnImportAll && inputImportAll) {
      btnImportAll.addEventListener('click', () => inputImportAll.click());
      inputImportAll.addEventListener('change', () => {
        if (inputImportAll.files && inputImportAll.files[0]) {
          importAll(inputImportAll.files[0]);
          inputImportAll.value = '';
        }
      });
    }

    // ---------- Servicios dropdown en Citas ----------
    async function fetchServiciosCatalog() {
      try {
        const res = await fetch("{% url 'api_solicitar_tabla' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: 'servicios' })
        });
        const data = await res.json();
        if (data.ok) {
          SERVICES_CACHE = (data.rows || []).map(r => ({
            id_servicio: r.id_servicio,
            servicio: r.servicio,
            precio: Number(r.precio || 0)
          }));
          servicesReady = true;
        }
      } catch (e) {
        servicesReady = false;
      }
    }

    async function fetchBarberosCatalog() {
      try {
        const res = await fetch("{% url 'api_solicitar_tabla' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: 'barbero' })
        });
        const data = await res.json();
        if (data.ok) {
          BARBEROS_CACHE = (data.rows || []).map(r => ({
            id_barbero: r.id_barbero,
            nombre: r.nombre
          }));
          barberosReady = true;
        }
      } catch (e) {
        barberosReady = false;
      }
    }

    function buildServiceOptions(selected, taken) {
      const opts = ['<option value=""></option>'];
      if (!SERVICES_CACHE.length) {
        if (selected) {
          opts.push(`<option value="${selected}" selected>${selected}</option>`);
        }
        return opts.join('');
      }
      SERVICES_CACHE.forEach(s => {
        const disabled = taken.has(s.id_servicio) && s.id_servicio !== selected;
        const sel = s.id_servicio === selected ? ' selected' : '';
        opts.push(`<option value="${s.id_servicio}"${sel}${disabled ? ' disabled' : ''}>${s.id_servicio} - ${s.servicio} ($${s.precio})</option>`);
      });
      return opts.join('');
    }

    function buildBarberoOptions(selected) {
      const opts = ['<option value=""></option>'];
      if (!BARBEROS_CACHE.length) {
        if (selected) opts.push(`<option value="${selected}" selected>${selected}</option>`);
        return opts.join('');
      }
      BARBEROS_CACHE.forEach(b => {
        const sel = b.id_barbero === selected ? ' selected' : '';
        opts.push(`<option value="${b.id_barbero}"${sel}>${b.id_barbero}${b.nombre ? ' - ' + b.nombre : ''}</option>`);
      });
      if (selected && !BARBEROS_CACHE.find(b => b.id_barbero === selected)) {
        opts.push(`<option value="${selected}" selected>${selected}</option>`);
      }
      return opts.join('');
    }

    function buildHoraOptions(selected, dataset, barberoId='', diaVal='', selfId='') {
      const opts = ['<option value=""></option>'];
      const hours = [
        "10:00","10:30","11:00","11:30","12:00","12:30",
        "13:00","13:30","14:00","14:30","15:00","15:30",
        "16:00","16:30","17:00","17:30","18:00"
      ];
      hours.forEach(h => {
        const sel = h === selected ? ' selected' : '';
        const availabilityClass = checkAvailability(barberoId, diaVal, h, selfId, dataset);
        opts.push(`<option value="${h}"${sel} class="${availabilityClass}">${h}</option>`);
      });
      return opts.join('');
    }

    function getRowValue(tr, colName) {
      const idx = cols.indexOf(colName);
      if (idx === -1) return '';
      const td = tr.children[idx];
      if (!td) return '';
      const sel = td.querySelector('select');
      if (sel) return sel.value || '';
      return (td.innerText || '').trim();
    }

    function checkAvailability(barberoId, diaVal, horaVal, selfId='', dataset=null) {
      if (!barberoId || !diaVal || !horaVal) return '';
      const pool = dataset || snapshotCitasFromDom();
      return pool.some(r =>
        r.id_barbero_id == barberoId &&
        r.dia == diaVal &&
        r.hora == horaVal &&
        (selfId ? r.id_cita != selfId : true)
      ) ? 'bad' : 'ok';
    }

    function colorizeHoraSelect(sel, barberoId, diaVal, selfId='', dataset=null) {
      const availability = checkAvailability(barberoId, diaVal, sel.value || '', selfId, dataset);
      sel.classList.remove('ok','bad');
      if (availability) sel.classList.add(availability);
    }

    function setupCitasCreateRow() {
      if (!SERVICES_CACHE.length) return;
      const row = document.getElementById('create-row');
      if (!row) return;
      const selects = Array.from(row.querySelectorAll('select[data-svc]'));
      const totalCell = document.getElementById('citas-total-cell');
      const horaSel = row.querySelector('select[data-hora="create"]');
      const barberoSel = row.querySelector('select[data-barbero="create"]');

      const refreshOptions = () => {
        const taken = new Set(selects.map(s => s.value).filter(Boolean));
        selects.forEach(sel => {
          const current = sel.value;
          sel.innerHTML = buildServiceOptions(current, taken);
        });
      };

      const computeTotal = () => {
        const ids = selects.map(s => s.value).filter(Boolean);
        const total = ids.reduce((acc, id) => {
          const svc = SERVICES_CACHE.find(x => x.id_servicio === id);
          return acc + (svc ? svc.precio : 0);
        }, 0);
        totalCell.textContent = total;
      };

      selects.forEach(sel => {
        sel.addEventListener('change', () => {
          const val = sel.value;
          const others = selects.filter(s => s !== sel).map(s => s.value);
          if (val && others.includes(val)) {
            sel.value = '';
          }
          refreshOptions();
          computeTotal();
        });
      });

      refreshOptions();
      computeTotal();

      // horas: 10:00 → 6:00 cada 30 min
      if (horaSel) {
        const barberoId = barberoSel ? barberoSel.value : getRowValue(row, 'id_barbero_id');
        const diaVal = getRowValue(row, 'dia');
        const dataset = snapshotCitasFromDom(false);
        horaSel.innerHTML = buildHoraOptions('', dataset, barberoId, diaVal, '');
        horaSel.addEventListener('change', () => {
          const b = barberoSel ? barberoSel.value : getRowValue(row, 'id_barbero_id');
          const d = getRowValue(row, 'dia');
          const ds = snapshotCitasFromDom(false);
          colorizeHoraSelect(horaSel, b, d, '', ds);
        });
        colorizeHoraSelect(horaSel, barberoId, diaVal, '', dataset);
      }

      if (barberoSel) {
        barberoSel.innerHTML = buildBarberoOptions(getRowValue(row, 'id_barbero_id'));
        barberoSel.addEventListener('change', () => {
          const b = barberoSel.value;
          const d = getRowValue(row, 'dia');
          const ds = snapshotCitasFromDom(false);
          colorizeHoraSelect(horaSel, b, d, '', ds);
        });
      }
    }

    function disableTotalEditingForCitas() {
      if (currentTable !== 'citas') return;
      document.querySelectorAll('#data-table tbody tr:not(#create-row) td').forEach((td, idx) => {
        const col = cols[idx];
        if (col === 'total') {
          td.removeAttribute('contenteditable');
        }
      });
    }

    const originalRenderTable = renderTable;
    renderTable = function(rows) {
      originalRenderTable(rows);
      if (currentTable === 'citas' && !isReadonly(currentTable)) {
        setupCitasCreateRow();
      }
      disableTotalEditingForCitas();
    };

    function enforceNoDuplicateEdit(sel) {
      const tr = sel.closest('tr');
      if (!tr) return;
      const selects = Array.from(tr.querySelectorAll('select[data-svc-edit]'));
      const taken = new Set(selects.map(s => s.value).filter(Boolean));
      selects.forEach(s => {
        const current = s.value;
        s.innerHTML = buildServiceOptions(current, taken);
        s.value = current;
        if (current && !s.value) {
          s.insertAdjacentHTML('afterbegin', `<option value="${current}" selected>${current}</option>`);
          s.value = current;
        }
      });
    }

    function computeRowTotal(tr) {
      const hasPrices = SERVICES_CACHE.length > 0;
      const tds = Array.from(tr.querySelectorAll('td'));
      const ids = [];
      tds.forEach((td, idx) => {
        const col = cols[idx];
        if (SERVICE_FIELDS.includes(col)) {
          const sel = td.querySelector('select');
          if (sel && sel.value) ids.push(sel.value);
        }
      });
      // hora: si hay select, asegurar opciones y valor actual + color
      const horaIdx = cols.indexOf('hora');
      if (horaIdx >= 0 && tds[horaIdx]) {
        const selHora = tds[horaIdx].querySelector('select');
        if (selHora) {
          const current = selHora.value || selHora.dataset.original || '';
          const barberoId = getRowValue(tr, 'id_barbero_id');
          const diaVal = getRowValue(tr, 'dia');
          const selfId = getRowValue(tr, 'id_cita');
          const dataset = snapshotCitasFromDom(false);
          selHora.innerHTML = buildHoraOptions(current, dataset, barberoId, diaVal, selfId);
          selHora.value = current;
          colorizeHoraSelect(selHora, barberoId, diaVal, selfId, dataset);
        }
      }
      const totalIdx = cols.indexOf('total');
      if (totalIdx < 0) return;
      const totalCell = tds[totalIdx];
      const originalTotal = totalCell.dataset.originalTotal || (totalCell.innerText || '').trim();
      const total = hasPrices
        ? ids.reduce((acc, id) => {
            const svc = SERVICES_CACHE.find(x => x.id_servicio === id);
            return acc + (svc ? svc.precio : 0);
          }, 0)
        : null;
      totalCell.innerText = (ids.length === 0 || total === null) ? originalTotal : total;
      totalCell.removeAttribute('contenteditable');
    }

    function setupEditSelectsForCitas() {
      editServiceControls = [];
      const rows = Array.from(document.querySelectorAll('#data-table tbody tr:not(#create-row)'));
      rows.forEach((tr, rowIdx) => {
        const selects = Array.from(tr.querySelectorAll('select[data-svc-edit]'));
        const originals = selects.map(s => s.dataset.original || '');
        selects.forEach((sel, idx) => {
          const current = originals[idx] || '';
          const taken = new Set(originals.filter(Boolean)); // por fila
          sel.innerHTML = buildServiceOptions(current, taken);
          sel.value = current;
          if (current && !sel.value) {
            sel.insertAdjacentHTML('afterbegin', `<option value="${current}" selected>${current}</option>`);
            sel.value = current;
          }
          editServiceControls.push(sel);
          sel.addEventListener('change', () => {
            enforceNoDuplicateEdit(sel);
            computeRowTotal(tr);
          });
        });
        // barbero: dropdown salvo rol barbero
        if (ROLE !== 'barbero') {
          const barIdx = cols.indexOf('id_barbero_id');
          if (barIdx >= 0 && tr.children[barIdx]) {
            const tdBar = tr.children[barIdx];
            const currentBar = (currentRowsData[rowIdx]?.id_barbero_id || tdBar.innerText || '').trim();
            tdBar.innerHTML = `<select data-barbero-edit="true" style="min-width:150px;"></select>`;
            const selBar = tdBar.querySelector('select');
            selBar.dataset.original = currentBar;
            selBar.innerHTML = buildBarberoOptions(currentBar);
            selBar.value = currentBar;
            selBar.addEventListener('change', () => {
              const ds = snapshotCitasFromDom(false);
              const horaIdx = cols.indexOf('hora');
              if (horaIdx >= 0 && tr.children[horaIdx]) {
                const selHora = tr.children[horaIdx].querySelector('select');
                if (selHora) {
                  const currentHora = selHora.value || selHora.dataset.original || '';
                  selHora.innerHTML = buildHoraOptions(currentHora, ds, selBar.value, getRowValue(tr, 'dia'), getRowValue(tr, 'id_cita'));
                  selHora.value = currentHora;
                  colorizeHoraSelect(selHora, selBar.value, getRowValue(tr, 'dia'), getRowValue(tr, 'id_cita'), ds);
                }
              }
            });
          }
        }
        // hora: sustituir por select con opciones y valor actual
        const horaIdx = cols.indexOf('hora');
        if (horaIdx >= 0 && tr.children[horaIdx]) {
          const tdHora = tr.children[horaIdx];
          const currentHora = (tdHora.innerText || '').trim();
          tdHora.innerHTML = `<select data-hora-edit="true"></select>`;
          const selHora = tdHora.querySelector('select');
          selHora.dataset.original = currentHora;
          const dataset = snapshotCitasFromDom(false);
          const barVal = ROLE === 'barbero' ? getRowValue(tr, 'id_barbero_id') : getRowValue(tr, 'id_barbero_id');
          selHora.innerHTML = buildHoraOptions(currentHora, dataset, barVal, getRowValue(tr, 'dia'), getRowValue(tr, 'id_cita'));
          selHora.value = currentHora;
          colorizeHoraSelect(selHora, barVal, getRowValue(tr, 'dia'), getRowValue(tr, 'id_cita'), dataset);
          selHora.addEventListener('change', () => {
            const ds = snapshotCitasFromDom(false);
            colorizeHoraSelect(selHora, barVal, getRowValue(tr, 'dia'), getRowValue(tr, 'id_cita'), ds);
          });
        }
        computeRowTotal(tr);
      });
    }

    // listeners de los botones de tabla
    function showRankingSection() {
      currentTable = null;
      setToolbarFor(null); // oculta toolbar
      wrap.innerHTML = '';
      statusEl.textContent = 'Ranking de servicios y clientes.';
      if (rankCard) rankCard.style.display = '';
      fetchRanking();
    }

    gridBtns.forEach(b => b.addEventListener('click', () => {
      // botón de ranking (no tabla)
      if (b.dataset && b.dataset.ranking) {
        showRankingSection();
        return;
      }
      // botones de tabla
      if (rankCard) rankCard.style.display = 'none';
      solicitarTabla(b.dataset.table);
    }));
    // opcional: precargar una tabla
    // solicitarTabla('duenio');

    // === Ranking (solo dueño) ===
    async function fetchRanking() {
      if (!btnRank) return;
      const inicio = document.getElementById('rank-inicio').value;
      const fin = document.getElementById('rank-fin').value;
      const limit = document.getElementById('rank-limit').value || 5;
      rankStatus.textContent = 'Cargando ranking...';
      rankWrap.innerHTML = '';
      try {
        const res = await fetch("{% url 'api_top_servicios_clientes' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inicio, fin, limit })
        });
        const data = await res.json();
        if (!data.ok) { rankStatus.textContent = data.error || 'Error'; return; }

        const { servicios = [], clientes = [] } = data;
        rankStatus.textContent = `Top ${limit} servicios y clientes`;

        const card = (title, rows, cols) => {
          if (!rows.length) return `<div class="hint">Sin datos para ${title.toLowerCase()}.</div>`;
          let html = `<div class="card" style="background:#0b1329;border:1px solid rgba(148,163,184,.2)"><div class="muted">${title}</div><table style="margin-top:6px;font-size:.9rem"><thead><tr>`;
          cols.forEach(c => html += `<th>${c}</th>`);
          html += '</tr></thead><tbody>';
          rows.forEach(r => {
            html += '<tr>';
            cols.forEach(c => html += `<td>${r[c] ?? ''}</td>`);
            html += '</tr>';
          });
          html += '</tbody></table></div>';
          return html;
        };

        rankWrap.innerHTML =
          card('Servicios', servicios, ['id_servicio','servicio','usos','total_estimado']) +
          card('Clientes', clientes, ['id_cliente','nombre','citas','total_gastado']);
      } catch (e) {
        rankStatus.textContent = 'Error de red';
      }
    }

    if (btnRank) {
      // valores por defecto de rango (año actual)
      const today = new Date();
      const yearStart = `${today.getFullYear()}-01-01`;
      document.getElementById('rank-inicio').value = yearStart;
      document.getElementById('rank-fin').value = today.toISOString().slice(0,10);
      btnRank.addEventListener('click', () => {
        if (rankCard) rankCard.style.display = '';
        fetchRanking();
      });
    }
  </script>
</body>
</html>
